# 关于自升级功能的推进计划

首先, 目前 (2024-05-01) 尚没有完成自升级的功能. 本文是一个备忘录, 用于指导未来的开发工作.

## 自升级流程与形式

1. 应用启动后, 会向服务器拉取最新的版本信息

    考虑到版本升级后的价格可能发生大变化, 我们需要一个阶梯式更新步骤. 例如, 处于 0.1 版本的用户, 只会拉取 0.x 的更新, 当升级到 0.x 后, 才会检查 1.x 的更新.

    使用 "协议版本号" 来规定这个阶梯范围. 在服务器端, 它的结构如下:

    ```
    oss:/depsland/apps/depsland
    |= manifests
        |- 0.1.0.json  # 协议版本号: 2024-04-30
        |- 0.1.1.json  # 协议版本号: 2024-05-01 <- 假设用户处于这个版本
        |- 0.1.2.json  # 协议版本号: 2024-05-01
        |- 0.2.0.json  # 协议版本号: 2024-05-01 <- 我们最多会拉取到这个版本
        |- 0.2.1.json  # 协议版本号: 2024-05-12 <- 然后, 第二次检查更新, 会拉取这个版本
        |- ...
    ```

2. 预下载更新文件, 我们采用的是增量更新方案, 所以此过程消耗的流量不会很大

2. 更新前检查文件是否被占用

    直到用户关闭所有占用进程的程序, 才会提醒用户更新.

4. 更新

5. 运行清理程序

6. 自动重启应用

我的愿景是能实现类似于 github desktop, google chrome, jetbrains toolbox app 那种顺滑, 友好的更新体验.

## 为什么现在不做自升级功能

- 该功能不在 0.7.0 的发布计划里
- 目前的用户数量少, 且处于内测阶段. 用户的升级需求非紧迫事项
- 我会根据自身需求调整不同工作事项的优先级, 目前来看自升级的优先级不高, 因为我个人一直在往项目上加新功能, 而且会经常做一些大的架构调整, 在这个时期做自升级, 是非常不稳定的

## 未来在什么时候做

- 用户量上来了, 且有更多公测用户参与
- 下一个大版本更新中正式考虑此功能时
- 有重要的用户反馈需要此功能
- 我个人对这件事提高了重视, 或者正好赶上某个相关的技术热点, 值得去探索时
- 版本的稳定性有了较大提升, 并且有较广泛的测试覆盖
